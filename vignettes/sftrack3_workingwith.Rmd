---
title: "3. Structure of sftrack/sftraj objects"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{3. Structure of sftrack/sftraj objects}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    fig.width = 6,
    fig.asp = 0.7
)
library("lwgeom")

```

This is section will go more depth into the structure of sftrack/sftraj objects and how to work with them.

To begin, `sftrack` and `sftraj` objects are essentially data.frame objects with the 3 required columns (group, geometry, and time). However, they are also of the subclass `sf`. This allows them to act like sf objects when working with functions in the `sf` package but act as `sftrack` objects for all other actions. It should be noted that when possible sftrack objects will mimic `sf` functionality and thus many of the same words and tactics are used.

```{r}
library("sftrack")
racc_track
racc_traj

```

In order for `sftrack` to function as an `sf` object, we create the data object as an `sf` object first (using st_as_sf()), and then add the `sftrack` attributes to the object. The class of an sftrack object is `sftrack` -> `sf` -> `data.frame` although the data.frame class is rarely called upon.

```{r}
class(racc_track)

```

There are five attributes total to an `sftrack` object, two of these are created by `sf` (`sf_column` and `agr`), and the additional three are created by `sftrack` (`group_col`, `time_col`, and `error_col`).

```{r}
attributes(racc_track)[-(1:2)]

```

The `sftrack` level attributes are simply pointers to the data. Any attributes relevant to the grouping or geometry are stored in those columns themselves. 


## Geometry

The geometry column is an `sfc` object and contains the important spatial information for the track. As NA points are common and important in movement data, we create the `sfc` object with the argument `na.fail = FALSE`. 

```{r}
racc_track$geometry

```

The `sfc` column varies in structure dependent on the movement class. An `sftrack` is a collection of `POINTs` while an `sftraj` is a `GEOMETRY` collection of `POINTs` and `LINESTRINGs`. 


```{r}
df1 <- data.frame(
  id = c(1, 1, 1, 1, 1, 1),
  month = c(1, 1, 1, 1, 1, 1),
  x = c(27, 27, 27, NA, 29, 30),
  y = c(-80, -81, -82, NA, 83, 83),
  timez = as.POSIXct("2020-01-01 12:00:00", tz = "UTC") + 60*60*(1:6)
)

test_sftraj <- as_sftraj(data = df1, group = list(id = df1$id, month = df1$month),
                         time = df1$timez, active_group = c("id","month"),
                         coords = df1[, c("x", "y")])
test_sftraj$geometry

```


## Grouping

The grouping column is very specialized, and we will cover it in its own section. To begin, the novel attributes it stores are the `active_group` and the `sort_index` which is a factor of the current active groups. The grouping class consists of single row level group: `s_groups` (a.k.a single groups) and a column level collection of s_groups called a `c_grouping` (a.k.a column/collection grouping). This column acts as a robust storage column for the groupings and is maintained across a `sftrack` object.

```{r}
attributes(racc_track$sft_group[1:10])
summary(racc_track)

```


## Time

The time column must be either an integer or POSIXct and the column must be of one type of time. Beyond that there is not much specialized functionality in the column. Sftrack uses the time column to order outputs for analysis, and attempts to order outputs when originally making an sftrack object, however, the data.frame is not required to be ordered for analysis. A call to `check_ordered()` is called before analysis, and otherwise it is assumed the order does not matter. This is particularly true for a sftraj, where the geometry level contains information about t1 and t2. 


## Error

The error column is the column with the relevant error information for the spatial points in it. At present we have not built particular functionality but plan to in the future or reserve this for other developers to build upon.


## Subsetting

An sftrack object acts like a data.frame and sf whenever appropriate. Because of this you can subset an sftrack object as you would a data.frame. 

In this way row subsetting is very straight forward, as each row represents an individual point in time.

```{r}
racc_track[1:10, ]

```

Unlike a data.frame, however, sftrack attempts to retain the geometry, group, and time columns, in order to maintain sftrack status. This is similar to how `sf` deals with the geometry column.

```{r}
racc_track[1:3, c(1:3)]

```

To turn off this feature, you use the `drop = T` argument which returns a `data.frame` object instead. If youd like to revert to an `sf` object, `sf::st_sf(data)` will return the object to an sf object.

```{r}
racc_track[1:3, c(1:3), drop = TRUE]

```

`sftraj`s work nearly the same as `sftrack`s, however because they are a step model where the steps are modeled as step1 ($t_1 â†’ t_2$) its important to note that subsetting will not automatically recalculate any new steps for you even if the original $t_2$ point has been deleted.

If your subsetting will also change the end points for steps, then you can recalculate using `step_recalc()`. The output which is your original sftraj object but with the geometry column recalculated to the new t2s based on the timestamp. The results of which can be wildly different than the original subsetted data.frame. So be careful.

```{r}
plot(racc_traj, main = "Original")
new_traj <- racc_traj[seq(10, nrow(racc_traj), 10), ]

plot(new_traj, main = "Before recalculation")

plot(step_recalc(new_traj),  main = "After recalculation")

```


## Some basic methods and functions of sftrack and sftraj objects


### `print`

The `print()` layout is a modified version of the `sf` print
function. It returns important info summarizing the `sftrack` object
like the geometry information and grouping information. The print
function defaults to printing 6 rows and displaying all the
columns. This can be modified using the `n` and `n_col` arguments,
which subset the printed output in the respective dimensions (use 
`n = Inf` to print all rows). When using `n_col` the display will show
the `grouping` `geometry`, and `time` fields as well as any other
columns starting from column 1 until **#columns + 3 = n_col**. `n` and
`n_col` are optional arguments, and if values are not supplied they
default to the data.frame defaults. Note: `n` is not a corrolary to
`head()`, as `head()` physically subsets the data while the `n` option
just modifies the printed output.

```{r}
print(racc_track, 5, 10)

```


### `summary`

`summary()` works as youd expect for a data.frame, except it displays
the grouping column as a count of each active_group combination and
the `active_group `for that column.

```{r}
summary(racc_track)

```


### `group_summary`

`group_summary()` is a special summary function specific for `sftrack`
and `sftraj` objects. It summarizes the data based on the beginning
and end of each grouping as well as the total distance and area
covered by the grouping. This function uses `st_distance`
and`st_convex_hull` from the `sf` package and therefore outputs in
units of the CRS. In this example the distance is in meters.

```{r}
group_summary(racc_track)

```

You can also trigger this function by using `summary(<data>, by_group = TRUE)`

```{r}
summary(racc_track, by_group = TRUE)

```
