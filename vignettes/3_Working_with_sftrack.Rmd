---
title: "3. Structure of sftrack/sftraj object"
output:
  pdf_document: default
  html_document: default
vignette: |
  %\VignetteIndexEntry{3. Structure of sftrack/sftraj object}
   %\VignetteEncoding{UTF-8}
   %\VignetteEngine{knitr::rmarkdown}
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::load_all("/home/matt/r_programs/sftrack")
#library(sftrack)

```
## Structure of sftrack objects.
sftrack and sftraj objects are given the subclass `sf` -> `data.frame`, so that they may act like sf objects when working with functions in the `sf` package but will retain their sftrack class. When possible sftrack objects will mimic sf functionality and thus many of the same words and tactics are used.

```{r}
# Make tracks from raw data
data <- read.csv(system.file('extdata/raccoon_data.csv', package='sftrack'))
data$month <- as.POSIXlt(data$acquisition_time)$mon+1

data$time <- as.POSIXct(data$acquisition_time, tz='EST')
coords = c('longitude','latitude')
burst = list(id = data$sensor_code, month = as.POSIXlt(data$acquisition_time)$mon+1)
time = 'time'
error = 'fix'
crs = '+init=epsg:4326'
my_sftrack <- as_sftrack(data = data, coords = coords, burst = burst, time = time, error = error, crs = crs)
my_sftraj <- as_sftraj(data = data, coords = coords, burst = burst, time = time, error = error, crs = crs)

```

sftrack/sftraj objects will always retain the 4 columns (burst, time, geometry, and error (if given)). They contain 4 novel attributes (burst, time, error, and sf_column). The 'sf_column' is created by `sf` and we add 3 additional attributes to the object. `agr` is calculated and used by `sf`, but is not specifically used by sftrack.

##### Geometry
Any attributes relative to the burst is stored in the burst column itself, as well as the geometry column contains many relevant attributes in the sfc column.
```{r}
attributes(my_sftrack)
```

As we will go over in later sections, an sftrack object has a geometry column which is simply an sfc of `POINT` objects. NA points are converted to Empty points. All geometry related information is stored in the sfc column and is dealt with via `sf` functions. 
```{r}
my_sftrack$geometry
```

An `sftraj` differs only in the geometry column. Where is it a GEOMETRY with mixture of LINESTRINGS or POINTS. Because sftrack allows NA points but LINESTRINGS can not have one point be a NULL, when t1 is a known point but t2 is an Unknown point then the geometry row contains a POINT object of t1. When t1 is unknown this row is an empty POINT object, regardless of the known status of t2.


```{r}
  df1 <- data.frame(
    id = c(1, 1, 1, 1,1,1),
    month = c(1,1,1,1,1,1),
    x = c(27, 27, 27, NA,29,30),
    y = c(-80,-81,-82,NA, 83,83),
    timez = as.POSIXct('2020-01-01 12:00:00', tz = 'UTC') + 60*60*(1:6)
  )

  test_sftraj <- as_sftraj(data = df1,burst=list(id=df1$id, month = df1$month),
    time = df1$timez, active_burst = c('id','month'), coords = df1[,c('x','y')])
  test_sftraj$geometry
```

##### Burst
The burst column is very specialized, and we will cover it in it's own section. The only special attributes it stores is the 'active_burst'. A burst column is a class 'multi_burst' consisuting of multiple 'ind_bursts'. All multi_bursts have 3 criteria. The contain the same active_bursts and the same grouping names. The 'ind_burst

```{r}
attributes(my_sftrack$burst)
summary(my_sftrack)
```

The time and error columns are not particularly specialized at this moment. THe time column is either an integer or POSIXct relative to the users input, but the entire column must remain that type.

The error column is the column with the relevant error information for the spatial points in it. At present we have not built particular functionality but plan to in the future or reserve this for other developers to build upon.


## Subsetting
An sftrack object attempts to act like a data.frame and sf whenever appropriate. Because of this you can subset an sftrack object as you would a data.frame. Except, like sf, it attempts to retain the geometry, burst, and time columns, in order to maintain sftrack status.

In this way row subsetting is very straight forward, as each row represents an individual point in time.

```{r}

my_sftrack[1:10,]
```

Subsetting by column however, sftrack attempts to retain imporatnt columns by default. This mirrors sf functionality except with multiple columns

```{r}

my_sftrack[1:3,c(1:3)]
```
}

To turn off this feature, you just use the drop = T argument which also returns a data.frame object instead, largely mimicing the use in 'sf'.

```{r}
my_sftrack[1:3,c(1:3), drop = TRUE]
```

sftrajs work nearly the same, however because they are a step model where in the steps are modeled as step1 (t1 ->t2) its important to note that subsetting will not automatically calculate any steps for you.

If your subsetting will also change your steps, creating new end points for steps, then you can recalculate using `step_recalc()`. The output which is your original straj object but with the geometry column recalculated to the new t2s. 

```{r}
plot(my_sftraj, main ='original', axes = T)
new_traj <- my_sftraj[seq(10,nrow(my_sftraj),10),]

plot(new_traj, main ='before recalculation', axes = T)

plot(step_recalc(new_traj),  main ='after recalculation', axes = T)
```
### Some basic functionality of sf_track and sf_traj objects
##### print  
`print()` prints out the type of object as well as specific data on the sf_track object. Additionally you can supply the number of rows or columns you'd like to display with arguments `n_row` and `n_col`. When using `n_col` the display will show the `burst` and `geometery` fields as well as any other columns starting from column 1 until `#columns + 2 = n_col`. If neither is provided than print just uses default values in the global options. `ncol` and `nrow` are optional arguments, defaults to data.frame defaults.

```{r}

print(my_sftrack,5,10)
```

##### summary  
`summary()` works as youd normally expect for a data.frame, except it displays the burst column as a count of each active_burst combination.  
```{r}
summary(my_sftrack)
```

##### summary_sftrack  
`summary_sftrack()` is a special summary function specific for sftrack objects. It summarizes the data based on the beginning and end of each burst as well as the total distance of the burst. This function uses `st_length` from the `sf` package and therefore outputs in units of the crs. In this example the distance is in degrees distance.
```{r}
summary_sftrack(my_sftrack)

```

You can also trigger this function by using `summary(data, stats = TRUE)`

```{r}
summary(my_sftrack, stats = TRUE)
```



